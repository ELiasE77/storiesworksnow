<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Journal Entries</title>
  <link rel="stylesheet" th:href="@{/css/journaling/journal_original.css}">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">
  <style>
    #speechIndicator { display: none; color: green; }
  </style>
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>
<section>
  <div class="journalEntry-container">
    <h1>Create your Journal entry!</h1>

    <!-- NOTE: no action or method here; JS will POST to /api/journal/save -->
    <form id="journal-form">
      <textarea name="title" id="titleText" placeholder="Write your title here..."></textarea>
      <textarea name="content" id="journal-content" placeholder="Write your journal entry here..."></textarea>

      <label for="visibility">Visibility:</label>
      <select name="visibility" id="visibility" required onchange="toggleCommunitySelector()">
        <option value="PRIVATE">Private</option>
        <option value="PUBLIC">Public</option>
        <option value="COMMUNITY">Community</option>
      </select>

      <div id="community-selector" style="display:none;">
        <label for="community">Select a community:</label>
        <select name="communityId" id="community">
          <option value="" disabled selected>Select a community</option>
          <option th:each="c : ${communities}"
                  th:value="${c.id}"
                  th:text="${c.name}"></option>
        </select>
      </div>

      <input type="hidden" name="imageUrl" id="imageUrl" value="">

      <div class="button-group">
        <button type="button" id="speechToTextBtn">Use Speech-to-Text</button>
        <button type="button" id="get-feedback">Get Feedback</button>
        <button type="button" id="generate-image">Generate Image</button>
        <button type="submit">Submit</button>
      </div>
      <div id="speechIndicator">üé§ Listening...</div>

      <h2>Select Image Style</h2>
      <div class="style-selection">
        <img th:src="@{/images/minimalist_style.png}" class="style-option" data-style="minimalist" alt="Minimalist">
        <img th:src="@{/images/labor_poster_style.png}" class="style-option" data-style="labor poster" alt="Labor Poster">
        <img th:src="@{/images/sketch_style.png}" class="style-option" data-style="sketch" alt="Sketch">
        <img th:src="@{/images/watercolor_style.png}" class="style-option" data-style="watercolor" alt="Watercolor">
      </div>
      <input type="hidden" id="selected-style" name="selected-style" value="minimalist">

      <div id="feedback">
        <h3>AI Feedback</h3>
        <p id="feedback-text"></p>
      </div>
      <div id="generated-image-container">
        <img id="generated-image" src="" alt="Generated Image" style="display:none;max-width:100%;" />
      </div>
      <div id="loading-indicator" style="display:none;">
        <p>Generating image, please wait...</p>
      </div>
    </form>
  </div>
</section>

<script th:src="@{/js/chatGPTIntegration/imageGeneration.js}"></script>
<script th:src="@{/js/chatGPTIntegration/textFeedback.js}"></script>
<script th:src="@{/js/component/speechToText.js}"></script>
<script th:src="@{/js/component/toggleCommunitySelector.js}"></script>

<!-- JSON‚Äêsubmit handler -->
<script>
  document.getElementById('journal-form')
          .addEventListener('submit', async function(e) {
            e.preventDefault();
            const payload = {
              title:       document.getElementById('titleText').value,
              content:     document.getElementById('journal-content').value,
              visibility:  document.getElementById('visibility').value,
              communityId: document.getElementById('community').value || null,
              imageUrl:    document.getElementById('imageUrl').value
            };
            const res = await fetch('/api/journal/save', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify(payload)
            });
            if (res.ok) {
              const json = await res.json();
              // redirect into ‚ÄúYour Entries‚Äù
              window.location.href = '/journal/home';
            } else {
              console.error('Save failed', await res.text());
            }
          });
</script>
</body>
</html>
